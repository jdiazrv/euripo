<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Apertura del Puente de Euripo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 id="title" class="text-2xl font-bold text-gray-800 mb-4">Calculadora de Apertura del Puente de Euripo</h1>
            <div class="mb-4">
                <label for="language" class="block text-sm font-medium text-gray-700">Idioma / Language:</label>
                <select id="language" class="mt-1 p-2 border rounded-md w-full">
                    <option value="es">Español</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="dateInput" id="dateLabel" class="block text-sm font-medium text-gray-700">Introduce la fecha (dd/mm/yyyy):</label>
                <input type="text" id="dateInput" placeholder="dd/mm/yyyy" class="mt-1 p-2 border rounded-md w-full">
            </div>
            <button id="calculateBtn" class="btn">Calcular</button>
            <div id="note" class="note"></div>
            <div id="result" class="mt-4"></div>
        </div>
        <div class="card mt-4">
            <h2 id="infoTitle" class="text-lg font-semibold text-gray-800 mb-2">Más Información</h2>
            <p id="infoContent" class="text-gray-600"></p>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        // Función para validar y parsear fecha en formato dd/mm/yyyy
        function parseDate(input) {
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = input.match(regex);
            if (!match) return null;
            const day = parseInt(match[1], 10);
            const month = parseInt(match[2], 10) - 1;
            const year = parseInt(match[3], 10);
            const date = new Date(year, month, day);
            if (isNaN(date) || date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) return null;
            return date;
        }

        // Verificar horario de verano (EEST)
        function isDST(date) {
            const year = date.getFullYear();
            const lastSundayMarch = new Date(year, 2, 31);
            lastSundayMarch.setDate(31 - (lastSundayMarch.getDay() || 7));
            const dstStart = new Date(Date.UTC(year, 2, lastSundayMarch.getDate(), 1));
            const lastSundayOctober = new Date(year, 9, 31);
            lastSundayOctober.setDate(31 - (lastSundayOctober.getDay() || 7));
            const dstEnd = new Date(Date.UTC(year, 9, lastSundayOctober.getDate(), 1));
            return date >= dstStart && date < dstEnd;
        }

        // Obtener fase lunar más cercana
        function getLunarPhaseInfo(inputDate) {
            const date = parseDate(inputDate);
            if (!date) return langData[currentLang].invalidDateFormat;
            date.setHours(0, 0, 0, 0);

            let lastNewMoon = null;
            let lastFullMoon = null;
            let nextFullMoon = null;
            for (let phase of [...newMoons, ...fullMoons]) {
                if (phase.type === 'new' && phase.date <= date) lastNewMoon = phase.date;
                if (phase.type === 'full' && phase.date <= date) lastFullMoon = phase.date;
                else if (phase.type === 'full' && phase.date > date && !nextFullMoon) nextFullMoon = phase.date;
            }
            if (!lastNewMoon || !lastFullMoon || !nextFullMoon) return langData[currentLang].noLunarData;

            const daysSinceNewMoon = Math.round((date - lastNewMoon) / (1000 * 60 * 60 * 24));
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return {
                lastNewMoon: lastNewMoon.toLocaleString(currentLang === 'es' ? 'es-ES' : 'en-GB', options),
                lastFullMoon: lastFullMoon.toLocaleString(currentLang === 'es' ? 'es-ES' : 'en-GB', options),
                nextFullMoon: nextFullMoon.toLocaleString(currentLang === 'es' ? 'es-ES' : 'en-GB', options),
                daysSinceNewMoon,
                isDST: isDST(date),
                inputDate: date
            };
        }

        // Obtener hora de apertura del puente
        function getBridgeOpeningTime(daysSinceNewMoon, referenceTime = "21:30", isDST = false) {
            if (daysSinceNewMoon < 0 || daysSinceNewMoon > 29 || !bridgeIntervals[Math.min(29, Math.max(0, daysSinceNewMoon))]) {
                return langData[currentLang].irregularStream;
            }

            const intervals = bridgeIntervals[Math.min(29, Math.max(0, daysSinceNewMoon))];
            const [refHour, refMinute] = referenceTime.split(":").map(Number);
            const refTimeMinutes = refHour * 60 + refMinute;

            for (let interval of intervals) {
                const [start, end] = interval.split("-");
                const [startHour, startMinute] = start.split(":").map(Number);
                const [endHour, endMinute] = end.split(":").map(Number);

                const startMinutes = startHour * 60 + startMinute;
                let endMinutes = endHour * 60 + endMinute;

                if (endHour < startHour) endMinutes += 24 * 60;

                if (refTimeMinutes >= startMinutes && refTimeMinutes <= endMinutes) {
                    let totalMinutes = endMinutes + 1;
                    if (isDST) totalMinutes += 60;
                    if (totalMinutes >= 24 * 60) totalMinutes -= 24 * 60;
                    const hours = Math.floor(totalMinutes / 60).toString().padStart(2, "0");
                    const minutes = (totalMinutes % 60).toString().padStart(2, "0");
                    return `${hours}:${minutes}${isDST ? ' (EEST)' : ' (EET)'}`;
                }
            }

            return langData[currentLang].refTimeNotFound;
        }

        // Calcular apertura del puente
        function calculateBridgeOpening(inputDate) {
            const lunarInfo = getLunarPhaseInfo(inputDate);
            if (typeof lunarInfo === "string") return lunarInfo;

            const isSaturday = lunarInfo.inputDate.getDay() === 6;
            const isWednesday = lunarInfo.inputDate.getDay() === 3;
            const isSummerWednesday = isWednesday && 
                lunarInfo.inputDate.getMonth() >= 5 && lunarInfo.inputDate.getMonth() <= 8;

            let result = {
                ...lunarInfo,
                bridgeOpeningTime: getBridgeOpeningTime(lunarInfo.daysSinceNewMoon, "21:30", lunarInfo.isDST)
            };

            if (isSaturday) {
                result.message = langData[currentLang].saturdayWarning;
            } else if (isSummerWednesday) {
                return langData[currentLang].summerWednesday;
            }

            return result;
        }

        // Manejar botón de cálculo
        function calculate() {
            const dateInput = document.getElementById("dateInput").value;
            const result = calculateBridgeOpening(dateInput);
            const resultDiv = document.getElementById("result");
            
            if (typeof result === "string") {
                resultDiv.innerHTML = `<p class="error">${result}</p>`;
            } else {
                let html = `
                    <p><strong>${langData[currentLang].lastNewMoon}:</strong> ${result.lastNewMoon}</p>
                    <p><strong>${langData[currentLang].lastFullMoon}:</strong> ${result.lastFullMoon}</p>
                    <p><strong>${langData[currentLang].nextFullMoon}:</strong> ${result.nextFullMoon}</p>
                    <p><strong>${langData[currentLang].daysSinceNewMoon}:</strong> ${result.daysSinceNewMoon}</p>
                    <p><strong>${langData[currentLang].bridgeOpeningTime}:</strong> ${result.bridgeOpeningTime}</p>
                `;
                if (result.message) {
                    html += `<p class="error">${result.message}</p>`;
                }
                resultDiv.innerHTML = html;
            }
        }

        // Datos de idioma
        const langData = {
            es: {
                title: "Calculadora de Apertura del Puente de Euripo",
                dateLabel: "Introduce la fecha (dd/mm/yyyy):",
                calculate: "Calcular",
                note: "Nota: Lo que se calcula es el momento en que no hay corriente a partir de las 21:30. Los datos provienen de la Port Authority de Chalkida. El cálculo no es una ciencia exacta y no garantiza que el puente abra a la hora indicada.",
                infoTitle: "Más Información",
                infoContent: `Para una explicación detallada del fenómeno de las mareas en el Euripo, visita <a href="https://www.antonios-antoniou.gr/en/tides-and-the-euripus-phenomenon" target="_blank" class="text-blue-600 hover:underline">esta página</a>. Consulta el horario oficial del puente en <a href="https://olne.gr/en/commercial-ports/chalkida-port/133-gefira-evripou/445-old-evripos-bridge-timetable" target="_blank" class="text-blue-600 hover:underline">la página oficial</a>.`,
                lastNewMoon: "Última luna nueva",
                lastFullMoon: "Última luna llena",
                nextFullMoon: "Próxima luna llena",
                daysSinceNewMoon: "Días desde la última luna nueva",
                bridgeOpeningTime: "Hora de apertura del puente",
                invalidDateFormat: "Formato de fecha inválido. Usa dd/mm/yyyy (ejemplo: 12/06/2025).",
                noLunarData: "No hay datos de fases lunares para esta fecha.",
                irregularStream: "Corriente irregular o sin datos para este día en el ciclo lunar.",
                refTimeNotFound: "Hora de referencia no encontrada en ningún intervalo.",
                saturdayWarning: "Nota: Los sábados el puente no abre, aunque la hora calculada es la indicada.",
                summerWednesday: "Nota: Los miércoles entre el 1 de junio y el 30 de septiembre el puente no abre."
            },
            en: {
                title: "Euripus Bridge Opening Calculator",
                dateLabel: "Enter the date (dd/mm/yyyy):",
                calculate: "Calculate",
                note: "Note: The calculation determines the moment of no current starting from 21:30. Data is provided by the Port Authority of Chalkida. The calculation is not an exact science and does not guarantee the bridge will open at the indicated time.",
                infoTitle: "More Information",
                infoContent: `For a detailed explanation of the tidal phenomenon in the Euripus, visit <a href="https://www.antonios-antoniou.gr/en/tides-and-the-euripus-phenomenon" target="_blank" class="text-blue-600 hover:underline">this page</a>. Check the official bridge timetable at <a href="https://olne.gr/en/commercial-ports/chalkida-port/133-gefira-evripou/445-old-evripos-bridge-timetable" target="_blank" class="text-blue-600 hover:underline">the official website</a>.`,
                lastNewMoon: "Last New Moon",
                lastFullMoon: "Last Full Moon",
                nextFullMoon: "Next Full Moon",
                daysSinceNewMoon: "Days since the last new moon",
                bridgeOpeningTime: "Bridge opening time",
                invalidDateFormat: "Invalid date format. Use dd/mm/yyyy (example: 12/06/2025).",
                noLunarData: "No lunar phase data available for this date.",
                irregularStream: "Irregular stream or no data for this day in the lunar cycle.",
                refTimeNotFound: "Reference time not found in any interval.",
                saturdayWarning: "Note: The bridge does not open on Saturdays, although the calculated time is shown.",
                summerWednesday: "Note: The bridge does not open on Wednesdays between June 1 and September 30."
            }
        };

        let currentLang = "es";

        // Cambiar idioma
        function changeLanguage() {
            currentLang = document.getElementById("language").value;
            document.getElementById("title").textContent = langData[currentLang].title;
            document.getElementById("dateLabel").textContent = langData[currentLang].dateLabel;
            document.getElementById("calculateBtn").textContent = langData[currentLang].calculate;
            document.getElementById("note").innerHTML = langData[currentLang].note;
            document.getElementById("infoTitle").textContent = langData[currentLang].infoTitle;
            document.getElementById("infoContent").innerHTML = langData[currentLang].infoContent;
            const resultDiv = document.getElementById("result");
            if (resultDiv.innerHTML) calculate();
        }

        // Añadir event listeners
        document.getElementById("calculateBtn").addEventListener("click", calculate);
        document.getElementById("language").addEventListener("change", changeLanguage);

        // Inicializar contenido al cargar la página
        window.onload = function() {
            document.getElementById("note").innerHTML = langData[currentLang].note;
            document.getElementById("infoTitle").textContent = langData[currentLang].infoTitle;
            document.getElementById("infoContent").innerHTML = langData[currentLang].infoContent;
        };
    </script>
</body>
</html>
